export default {
  async fetch(request) {
    // üî¥ SECCI√ìN MANUAL - T√ö EDITAS ESTO DIRECTAMENTE
    // =================================================
    // üé¨ Si pones videoEmbed, se REPRODUCE EL VIDEO
    // üñºÔ∏è Si NO pones videoEmbed, se muestra MINIATURA
    const MANUAL_VIDEOS = [
      { 
        id: 'VIDEO_ID_1',
        title: 'USTEDES DECIDEN LA SERIE',
        description: 'En este video decidimos qu√© serie vamos a ver...',
        thumbnail: 'https://i.ytimg.com/vi/2xKgRUMTJkI/mqdefault.jpg',
        videoEmbed: 'https://wiedman.com.co/wp-content/uploads/2026/02/agharta_video.mp4', // ‚Üê TU VIDEO
        date: '10 feb 2026',
        views: '1,234'
      },
      { 
        id: 'VIDEO_ID_2',
        title: 'LO QUE SUCEDIO EN EL CANAL',
        description: 'Actualizaci√≥n importante...',
        thumbnail: 'https://i.ytimg.com/vi/i5HiFgEzf4c/mqdefault.jpg',
        videoEmbed: '', // ‚Üê VAC√çO = USA MINIATURA
        date: '8 feb 2026',
        views: '892'
      }
    ];

    // üî¥ TU API KEY (PONLA AQU√ç)
    const API_KEY = 'AIzaSyCVAn_8PFMPIDcM_ozGMLr-yd-mNDvUGPU'; // ‚Üê PEGA TU API KEY AQU√ç
    const CHANNEL_ID = 'UCIbWfCngxTPu8Qp4VyN97XA'; // ‚Üê TU CANAL
    
    let videos = MANUAL_VIDEOS; // Por defecto, usa manual

    // üü¢ INTENTAR USAR API (solo si hay API_KEY)
    if (API_KEY && API_KEY.trim() !== '') {
      try {
        const searchUrl = `https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&channelId=${CHANNEL_ID}&part=snippet&order=date&maxResults=5&type=video`;
        const searchRes = await fetch(searchUrl);
        
        if (searchRes.ok) {
          const searchData = await searchRes.json();
          
          if (searchData.items && searchData.items.length > 0) {
            const videoIds = searchData.items.map(item => item.id.videoId).join(',');
            
            const detailsUrl = `https://www.googleapis.com/youtube/v3/videos?key=${API_KEY}&id=${videoIds}&part=statistics,snippet`;
            const detailsRes = await fetch(detailsUrl);
            
            if (detailsRes.ok) {
              const detailsData = await detailsRes.json();
              
              videos = detailsData.items.map(item => ({
                id: item.id,
                title: item.snippet.title || 'Sin t√≠tulo',
                description: item.snippet.description.substring(0, 80) + (item.snippet.description.length > 80 ? '...' : ''),
                thumbnail: `https://i.ytimg.com/vi/${item.id}/mqdefault.jpg`,
                videoEmbed: `https://www.youtube.com/embed/${item.id}?autoplay=1&mute=1&loop=1&playlist=${item.id}`,
                date: new Date(item.snippet.publishedAt).toLocaleDateString('es-CO', { 
                  day: 'numeric', month: 'short', year: 'numeric' 
                }),
                views: parseInt(item.statistics.viewCount || 0).toLocaleString()
              }));
            }
          }
        }
      } catch (error) {
        console.log('API fall√≥, usando videos manuales');
      }
    }

    const url = new URL(request.url);
    let index = parseInt(url.searchParams.get('v') || '0');
    if (isNaN(index) || index >= videos.length) index = 0;
    
    const nextIndex = (index + 1) % videos.length;
    const nextUrl = `${url.pathname}?v=${nextIndex}`;
    const video = videos[index];

    // üü¢ DETECTAR SI HAY VIDEO EMBEBIDO
    const tieneVideo = video.videoEmbed && video.videoEmbed.trim() !== '';

    const html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="30;url=${nextUrl}">
    <meta http-equiv="Cache-Control" content="no-cache, no-store">
    <title>@wiedmanhub - ARCHIVO W</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            padding: 20px;
        }
        .card {
            width: 380px;
            height: 300px;
            background: rgba(15,20,30,0.2);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.15);
            display: flex;
            flex-direction: column;
        }
        .thumb {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 6px;
            background: #000;
            flex-shrink: 0;
        }
        .thumb video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .live {
            position: absolute;
            top: 6px;
            left: 6px;
            background: #ff0000;
            padding: 3px 8px;
            border-radius: 20px;
            color: white;
            font-size: 9px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 3px;
            border: 1px solid rgba(255,255,255,0.3);
            z-index: 10;
        }
        .live::before { content: "üî¥"; }
        .progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            width: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 10;
        }
        .bar {
            height: 100%;
            width: 0%;
            background: #ff0000;
            animation: progress 30s linear;
        }
        @keyframes progress { from { width: 0%; } to { width: 100%; } }
        .title {
            color: white;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 3px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 0;
        }
        .description {
            color: rgba(255,255,255,0.8);
            font-size: 10px;
            margin-bottom: 4px;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 0;
        }
        .info-row {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255,255,255,0.8);
            font-size: 10px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .channel-name {
            color: #ff4d4d;
            font-weight: 600;
            white-space: nowrap;
        }
        .video-date {
            color: rgba(255,255,255,0.7);
            white-space: nowrap;
        }
        .video-views {
            color: rgba(255,255,255,0.7);
            white-space: nowrap;
        }
        .video-counter {
            color: rgba(255,255,255,0.7);
            margin-left: auto;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="thumb">
            ${tieneVideo ? 
              `<video autoplay loop muted playsinline>
                  <source src="${video.videoEmbed}" type="video/mp4">
                  Tu navegador no soporta la etiqueta de video.
               </video>` : 
              `<img src="${video.thumbnail}" 
                    onerror="this.src='https://i.ytimg.com/vi/${video.id}/default.jpg'">`
            }
            <div class="live">ARCHIVO W</div>
            <div class="progress"><div class="bar"></div></div>
        </div>
        
        <div class="title" title="${video.title}">${video.title}</div>
        <div class="description" title="${video.description}">${video.description || 'Sin descripci√≥n disponible'}</div>
        
        <div class="info-row">
            <span class="channel-name">@wiedmanhub</span>
            <span class="video-date">üìÖ ${video.date}</span>
            <span class="video-views">üëÅÔ∏è ${video.views || '---'}</span>
            <span class="video-counter">üé¨ ${index + 1}/${videos.length}</span>
        </div>
    </div>
</body>
</html>`;

    return new Response(html, {
      headers: {
        'Content-Type': 'text/html; charset=utf-8',
        'Cache-Control': 'no-cache, no-store',
        'Access-Control-Allow-Origin': '*'
      }
    });
  }
}
